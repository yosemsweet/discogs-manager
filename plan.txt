# Discogs Manager CLI - Development Plan

## Current Session: Codebase Review and Improvement Strategy

### Completed: Comprehensive Codebase Review
A detailed code quality review has been completed and documented in `CODEBASE_REVIEW.md`.

**Key Findings:**
- üü¢ **Overall Health:** Good - Clean architecture with layered design
- üü° **Code Quality:** Mixed - Good structure, some technical debt
- üî¥ **Issues Identified:** 10 major weaknesses (see details below)

**Test Status:** 91/95 passing (4 integration test failures due to incomplete mocking)

### Top 5 Priorities for Improvement:
1. **üî¥ CRITICAL:** Fix 4 failing integration tests
2. **üü† HIGH:** Centralize error handling (currently scattered)
3. **üü† HIGH:** Reduce command handler duplication (6 identical patterns)
4. **üü° MEDIUM:** Enable TypeScript strict mode
5. **üü° MEDIUM:** Refactor PlaylistService (breaking up ~300 lines)

### Recommended Next Steps:
Phase 1 (Weeks 1-2): Fix tests + centralize errors + reduce duplication
Phase 2 (Weeks 3-4): Refactor services + add validation layer
Phase 3 (Weeks 5-6): Optimize performance (caching, concurrency)
Phase 4 (Weeks 7-8): Add robustness (logging, recovery, sanitization)
Phase 5 (Weeks 9-10): Documentation and test coverage

**Estimated Total Effort:** 52-69 hours for all improvements

See `CODEBASE_REVIEW.md` for detailed analysis and implementation plan.

---

## Previous Session: Fetch Full Tracklists from Discogs for Multi-Track Playlists

### Problem Identified:
System was only getting ONE track per Discogs release, limiting playlists to 50 tracks maximum (if syncing 50 records). Each record can have 10+ tracks, but we weren't fetching them.

### Solution Implemented:
1. **Database Tracklist Caching** ‚úÖ
   - Added `tracks` table to store release tracklists (title, artists, position, duration)
   - Unique constraint on (releaseId, position) to prevent duplicates
   
2. **Collection Sync Enhancement** ‚úÖ
   - CollectionService now stores the full tracklist when syncing each release
   - Tracklist fetched from Discogs `/releases/{id}` endpoint (same call as before)
   - Stores in database for reuse during playlist creation
   
3. **Playlist Creation Refactoring** ‚úÖ
   - PlaylistService now queries database for cached tracks instead of calling Discogs API again
   - For each release, fetches all tracks from database
   - Searches SoundCloud for EACH individual track (not just one per album)
   - Can now create playlists with 100+ tracks per album
   
4. **Database Fixes** ‚úÖ
   - Enabled `foreign_keys` pragma in SQLite to prevent constraint violations
   - Clarified messaging to show "individual tracks" from multiple releases

### Current Status:
‚úÖ Playlists are being created with multiple tracks per release
‚ö†Ô∏è Playlist creation is **inconsistent** - got 422 error for "My Folk Collection"
   - Jazz playlists worked
   - Folk playlists failed with 422 (Unprocessable Entity)
   - Suggests issue with certain track data or SoundCloud API constraints

### Next Steps:
- Investigate 422 error - likely invalid track IDs or malformed requests
- Check if certain genres/artists cause issues
- May need to validate track IDs before sending to SoundCloud
- Could be rate limiting or data validation issue

## Previous Session: Add Support for More Than 50 Tracks in Playlists

The system currently seems limited to 50 tracks per playlist. This could be:
1. SoundCloud API batch size limit
2. Our internal batching logic
3. Frontend constraint

### Plan:
1. **Batch Playlist Creation** - If more than 50 tracks, create playlist then add tracks in batches
2. **Batch Add Tracks** - Implement batching in addTracksToPlaylist with configurable batch size
3. **Update PlaylistService** - Use batching logic for large track counts
4. **Test with 100+ tracks** - Verify the system can handle larger playlists

## Project Overview
A command-line interface for managing Discogs music collections and creating SoundCloud playlists from collection subsets.

## Critical Issue: SoundCloud API Integration Needs Fixes
‚úÖ RESOLVED - All API endpoints now match SoundCloud documentation

## Completed Tasks (Previous Sessions)
1. **Wrong Endpoint for Playlist Creation**
   - Current: `POST /me/playlists`
   - Should be: `POST /playlists`
   
2. **Incorrect Request Body Structure**
   - Current: Direct `{tracks: [...]}` 
   - Should be: Wrapped in `{playlist: {tracks: [...]}}`
   - Affects both create and add operations

3. **Inefficient Flow**
   - Creates empty playlist first, then adds tracks one-by-one
   - Should include all tracks in initial creation request
   - This reduces API calls significantly

4. **Missing Response Validation**
   - Playlist response not validated for required fields
   - Error "Invalid playlist ID: must be a non-empty string" suggests id extraction is failing

### Reference: SoundCloud API Docs
**Create Playlist:**
```
POST /playlists
-d "{'playlist': {'title':'YOUR_TITLE', 'sharing':'public', 'tracks':[{'id':1},{'id':2}]}}"
```

**Add Tracks:**
```
PUT /playlists/PLAYLIST_ID
-d "{'playlist': {'tracks':[{'id':1}, {'id':2}]}}"
```

## Fix Implementation Plan (ACTIVE BRANCH: fix/soundcloud-api)

### Phase 1: Fix Core API Issues
- [ ] Update `createPlaylist()` endpoint from `/me/playlists` to `/playlists`
- [ ] Wrap request body in `playlist` object wrapper
- [ ] Fix `addTrackToPlaylist()` to wrap tracks in `playlist` object
- [ ] Add response validation and better error logging
- [ ] Create `createPlaylistWithTracks()` method for batch creation

### Phase 2: Optimize Playlist Service
- [ ] Modify `PlaylistService.createPlaylist()` to collect all tracks first
- [ ] Use new batch method to create playlist with all tracks in one call
- [ ] Reduce total API calls from (1 create + N adds) to (1 create + N searches)

### Phase 3: Testing & Validation
- [ ] Build with `npm run build`
- [ ] Test auth with `npm run dev -- auth` (verify token is valid)
- [ ] Test playlist with `npm run dev -- playlist --title "Test Jazz" --genres "Jazz"`

## Completed Tasks (Previous Sessions)
- [x] Full TypeScript/Node.js CLI implementation with all 5 commands (sync, list, stats, retry, playlist)
- [x] Discogs API integration with pagination support (handles collections 50+ items)
- [x] SQLite database with better-sqlite3 (synchronous, WAL-enabled, reliable)
- [x] Service layer: CollectionService, PlaylistService, DatabaseManager
- [x] Advanced filtering: genres, styles, year range, rating range
- [x] Comprehensive error handling: retry queue + dead letter queue for failed releases
- [x] Local rate limit throttling (proactive, no 429 errors)
- [x] Database optimization: skip existing releases unless --force flag
- [x] Progress feedback with ora spinners across all commands
- [x] Full test suite: 93 tests passing (100% pass rate)
- [x] Clean CLI lifecycle: proper process exit handling
- [x] SoundCloud OAuth 2.1 with PKCE implementation
- [x] Auth command with browser-based flow
- [x] Improved auth command error handling and process finalization

## Build Status
‚úÖ Project compiles without errors (awaiting SoundCloud API fixes)
‚úÖ All 93 tests passing (100% pass rate)
‚úÖ OAuth 2.1 authentication working
‚ö†Ô∏è Playlist creation failing due to API mismatches

## Session History
- **Session 6**: Migrated sqlite3 ‚Üí better-sqlite3, implemented Discogs pagination
- **Session 8**: Added error handling (retry queue + DLQ), local rate limit throttling, database skip-existing optimization
- **Session 9**: Merged feature/make-retries-work to master
- **Session 10**: Implemented list command comprehensive filtering (genres, styles, year range, rating range), updated documentation
- **Session 11**: Enhanced stats command with genre/style breakdown by count, added --verbose flag
- **Session 14**: Completed SoundCloud rate limit implementation, merged to master
- **Session 15**: Implemented OAuth 2.1 with PKCE, improved auth command, merged to master
- **Current**: Fixing SoundCloud API endpoint mismatches (branch: fix/soundcloud-api)
   - Calls throttleIfApproachingLimit() in playlist creation loop
   - Throws descriptive error if limit exceeded

‚úÖ **Step 5: Update playlist command with rate limit feedback**
   - Added SoundCloudRateLimitService import to playlist command
   - Creates rate limit service with database
   - Initializes from database on startup (restore previous state)
   - Passes service to PlaylistService
   - Enhanced error handling for rate limit errors with descriptive messages

‚úÖ **Step 6: Store rate limit state in database**
   - Added soundcloud_rate_limit table to database schema
   - Fields: id (primary), remaining, resetTime, maxRequests, lastUpdated
   - Implemented saveRateLimitState() method in DatabaseManager
   - Implemented getRateLimitState() method to restore on startup
   - SoundCloudRateLimitService now persists state after each API response
   - Automatically restores previous state via initializeFromDatabase()

‚úÖ **Step 7: Add comprehensive rate limit error tests**
   - Added 8 new test cases to error-handling.test.ts
   - Tests cover: error parsing, zero requests, approaching limit, exceeded limit, time calculations, formatting
   - All tests passing with 125 total tests (97 existing + 28 new for rate limiting)
   - No regressions in other functionality

‚úÖ **Step 8: Update README documentation**
   - Enhanced "Rate Limiting" section with both Discogs and SoundCloud info
   - Explains SoundCloud 15,000 per 24-hour limit
   - Added automatic throttling behavior explanation
   - Shows example log messages
   - Updated troubleshooting section with SoundCloud rate limit guidance
   - Added soundcloud_rate_limit table to database documentation

‚úÖ **Step 9: Final test verification**
   - Confirmed all 125 tests passing (100% pass rate)
   - No regressions in existing functionality
   - TypeScript compiles cleanly

‚úÖ **Step 10: Commit all changes**
   - 6 commits to feature/soundcloud-rate-limiting branch:
     - Step 3: Throttling strategy
     - Step 5: Playlist command feedback
     - Step 6: Database persistence
     - Step 7: Error tests
     - Step 8: README documentation
   - All commits on feature branch

‚úÖ **Step 11: Merge to master**
   - Fast-forward merged feature/soundcloud-rate-limiting to master
   - 9 files changed: +769 lines, -141 lines
   - New files: soundcloud-rate-limit.ts (182 lines), soundcloud-rate-limit.test.ts (163 lines)
   - Updated: soundcloud.ts, playlist.ts, database.ts, error-handling.test.ts, README.md, plan.txt
   - Final verification: 125 tests passing, clean build on master

### Implementation Summary

The SoundCloud rate limit handling is now fully production-ready:

**Architecture:**
- **SoundCloudRateLimitService**: Manages rate limit state with database persistence
- **SoundCloudRateLimitError**: Custom error class for 429 responses
- **Throttling Logic**: Automatic pause when approaching limit, resume after reset
- **Database Persistence**: Stores/restores rate limit state across CLI runs
- **Command Integration**: Playlist command creates and initializes rate limit service

**Features:**
- Prevents 429 errors through proactive throttling
- 15,000 requests per 24-hour window
- Automatic pause and resume without user intervention
- Detailed logging with human-readable wait times
- Reset time tracking and persistence
- Comprehensive test coverage (20 rate limit tests + 8 error tests)

**Test Coverage:**
- 125 total tests passing (97 existing + 28 new)
- SoundCloudRateLimitService: 20 unit tests
- Error handling: 8 rate limit error tests
- 100% pass rate with no regressions

**Documentation:**
- README explains both Discogs and SoundCloud throttling
- Troubleshooting section covers 24-hour reset guidance
- Database documentation includes soundcloud_rate_limit table

### Branch Status
- **Master:** Ready for production with all 11 steps completed and merged
- **Feature branch:** feature/soundcloud-rate-limiting merged (can be deleted)

### Ready for Next Session
The project is now ready for:
1. Additional features or enhancements
2. Bug fixes or edge case handling
3. Performance optimizations
4. User testing and feedback

## Session 11 - Completed: Enhance Stats Command

**Status:** ‚úÖ COMPLETED and merged to master
- Enhanced stats command with genre/style breakdown by count
- CollectionService updated with getGenreStats() and getStyleStats()
- Stats command displays top genres with release counts
- Added --verbose flag for detailed style breakdown
- All tests passing (93+ tests)
- Merged feature/stats-command-enhancement to master

## Completed Features Summary