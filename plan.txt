# Discogs Manager CLI - Development Plan

## Project Overview
A command-line interface for managing Discogs music collections and creating SoundCloud playlists from collection subsets.

## Completed Tasks
- [x] Full TypeScript/Node.js CLI implementation with all 5 commands (sync, list, stats, retry, playlist)
- [x] Discogs API integration with pagination support (handles collections 50+ items)
- [x] SQLite database with better-sqlite3 (synchronous, WAL-enabled, reliable)
- [x] Service layer: CollectionService, PlaylistService, DatabaseManager
- [x] Advanced filtering: genres, styles, year range, rating range
- [x] Comprehensive error handling: retry queue + dead letter queue for failed releases
- [x] Local rate limit throttling (proactive, no 429 errors)
- [x] Database optimization: skip existing releases unless --force flag
- [x] Progress feedback with ora spinners across all commands
- [x] Full test suite: 93 tests passing (100% pass rate)
- [x] Clean CLI lifecycle: proper process exit handling
- [x] Complete documentation: README, CONTRIBUTING, API_REFERENCE

## Build Status
✅ Project compiles without errors
✅ All 93 tests passing (100% pass rate)
✅ Ready for production with robust error handling and rate limiting

## Session History
- **Session 6**: Migrated sqlite3 → better-sqlite3, implemented Discogs pagination
- **Session 8**: Added error handling (retry queue + DLQ), local rate limit throttling, database skip-existing optimization
- **Session 9**: Merged feature/make-retries-work to master
- **Session 10**: Implemented list command comprehensive filtering (genres, styles, year range, rating range), updated documentation

## Current Session (Session 11) - In Progress: Enhance Stats Command

### Goal
Update stats command to show releases per genre (fixing README/implementation mismatch) and add optional verbose mode for style breakdown.

### Steps to Implement
1. **Update CollectionService.getStats() return type**
   - Change from returning `genres: string[]` to `genreStats: Map<string, number>` (genre name → release count)
   - Add `styleStats?: Map<string, number>` for verbose mode
   - Current: returns only unique genre names (array)
   - Target: returns genre names with count of releases containing that genre

2. **Implement getGenreStats() method in CollectionService**
   - Iterate through all releases and count occurrences of each genre
   - Handle comma-separated genres in each release (split and count each)
   - Return sorted map by count descending
   - Reuse for both stats and optional verbose stats

3. **Implement getStyleStats() method in CollectionService** (for verbose mode)
   - Similar to getGenreStats but for styles field
   - Only called when verbose flag is set
   - Return sorted map by count descending

4. **Update stats command to accept --verbose flag**
   - Add `.option('-v, --verbose', 'Show detailed stats including style breakdown')`
   - Pass verbose flag to collectionService.getStats(verbose)

5. **Update CollectionService.getStats(verbose?) signature**
   - Accept optional verbose boolean parameter
   - Call getStyleStats() only when verbose is true
   - More efficient than always calculating styles

6. **Update stats command output formatting**
   - Show "Top Genres:" with counts (e.g., "Rock: 15 releases")
   - Display top 10 genres sorted by release count (descending)
   - When verbose: add "Top Styles:" section below genres with same format
   - Format: `  • Genre Name: N releases`

7. **Update README stats section**
   - Fix example output to match new format with release counts
   - Add verbose example: `npm run dev -- stats yosemsweet --verbose`
   - Update output section to show genre counts

8. **Add tests for new stats functionality**
   - Test getGenreStats() returns correct genre counts
   - Test getStyleStats() returns correct style counts
   - Test stats command output includes genre counts
   - Test verbose flag triggers style stats calculation
   - Test sorting by count (descending)
   - Update existing stats tests (currently 3 tests checking old behavior)

9. **Verify all tests pass**
   - Run full test suite: `npm test`
   - Ensure 93+ tests passing (adding ~5-6 new tests)
   - Check no regressions in existing functionality

10. **Commit changes**
    - Branch: `feature/stats-command-enhancement`
    - Message: "feat: enhance stats command with genre/style breakdown by count"
    - Include: CollectionService, stats command, tests, README

## Completed Features Summary