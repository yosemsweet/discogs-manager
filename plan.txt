# Discogs Manager CLI - Development Plan

## Project Overview
A command-line interface for managing Discogs music collections and creating SoundCloud playlists from collection subsets.

## Completed Tasks
- [x] Full TypeScript/Node.js CLI implementation with all 5 commands (sync, list, stats, retry, playlist)
- [x] Discogs API integration with pagination support (handles collections 50+ items)
- [x] SQLite database with better-sqlite3 (synchronous, WAL-enabled, reliable)
- [x] Service layer: CollectionService, PlaylistService, DatabaseManager
- [x] Advanced filtering: genres, styles, year range, rating range
- [x] Comprehensive error handling: retry queue + dead letter queue for failed releases
- [x] Local rate limit throttling (proactive, no 429 errors)
- [x] Database optimization: skip existing releases unless --force flag
- [x] Progress feedback with ora spinners across all commands
- [x] Full test suite: 93 tests passing (100% pass rate)
- [x] Clean CLI lifecycle: proper process exit handling
- [x] Complete documentation: README, CONTRIBUTING, API_REFERENCE

## Build Status
✅ Project compiles without errors
✅ All 93 tests passing (100% pass rate)
✅ Ready for production with robust error handling and rate limiting

## Session History
- **Session 6**: Migrated sqlite3 → better-sqlite3, implemented Discogs pagination
- **Session 8**: Added error handling (retry queue + DLQ), local rate limit throttling, database skip-existing optimization
- **Session 9**: Merged feature/make-retries-work to master
- **Session 10**: Implemented list command comprehensive filtering (genres, styles, year range, rating range), updated documentation
- **Session 11**: Enhanced stats command with genre/style breakdown by count, added --verbose flag

## Current Session (Session 12) - In Progress: Handle SoundCloud Rate Limits

### Goal
Implement SoundCloud API rate limit handling to prevent 429 errors and enable graceful throttling for playlist creation operations.

### SoundCloud Rate Limit Context
- **Global Rate Limit**: None (no aggregate limit enforced)
- **Play Request Limit**: 15,000 requests per 24-hour window (includes `/tracks/:id/stream`)
- **Rate Limit Window**: 24-hour rolling window (resets after first request expires)
- **Error Response**: HTTP 429 with JSON body containing:
  - `group`: "plays" (rate limit group name)
  - `max_nr_of_requests`: 15,000
  - `time_window`: "PT24H" (ISO 8601 format)
  - `remaining_requests`: Number of requests left
  - `reset_time`: When limit resets (format: `yyyy/MM/dd HH:mm:ss Z`)

### Steps to Implement
1. **Create SoundCloud rate limit tracking service**
   - New file: `src/services/soundcloud-rate-limit.ts`
   - Track rate limit state: `remaining`, `reset_time`, `max_requests`
   - Methods: `updateFromResponse()`, `isApproachingLimit()`, `getTimeUntilReset()`
   - Store state to database for persistence across CLI runs
   - Add database table: `soundcloud_rate_limit` (username, remaining, reset_time, max_requests, last_updated)

2. **Update SoundCloudAPIClient with rate limit handling**
   - Parse HTTP 429 response and extract rate limit metadata from JSON error body
   - Create custom error: `SoundCloudRateLimitError` extending existing error class
   - Extract `reset_time`, `remaining_requests` from response body
   - Log rate limit info with: remaining requests, reset time, time until reset
   - Create `createPlaylistWithTracks()` method that:
     - Pre-checks if approaching limit before attempting creation
     - Validates sufficient requests remain before proceeding
     - Returns error with reset_time if limit exceeded

3. **Implement throttling strategy in SoundCloudAPIClient**
   - Add method `throttleIfApproachingLimit()` similar to Discogs implementation
   - If `remaining_requests ≤ 5`: warn and pause until reset_time
   - Display: "SoundCloud rate limit nearly exhausted. Pausing until reset..."
   - Calculate wait time from response reset_time
   - Resume automatically when reset_time passes
   - Log resume message with full request allowance restored

4. **Update PlaylistService with rate limit awareness**
   - Fetch current rate limit state before creating playlist
   - Check if sufficient requests remain (need N requests for tracks to add)
   - Inform user if approaching/exceeding limit: show reset_time
   - Suggest alternative: "Try again after [reset_time]"
   - Add optional `--force` flag to skip limit check (not recommended)

5. **Update playlist command with better feedback**
   - Add progress tracking for playlist creation
   - Display message before rate limit check: "Checking SoundCloud rate limits..."
   - On rate limit error: show reset_time and explain why creation failed
   - Offer suggestion: "Your rate limit will reset at [reset_time]. Try again then."
   - Log rate limit state before and after operation

6. **Update SoundCloudAPIClient to store rate limit in database**
   - After each SoundCloud API call, update rate limit table
   - Store: `remaining_requests`, `reset_time`, `max_requests`, `timestamp`
   - Query on startup to restore previous rate limit state
   - Help avoid repeated 429 errors across CLI invocations

7. **Add tests for SoundCloud rate limit handling**
   - Test parsing 429 response with rate limit metadata
   - Test rate limit service: tracking remaining, checking limit, calculating reset time
   - Test throttling logic: pause when approaching limit
   - Test edge cases: zero remaining, past reset_time, invalid reset_time format
   - Test playlist creation with rate limit check
   - Mock SoundCloud responses with various rate limit scenarios

8. **Update error handling tests**
   - Add test for `SoundCloudRateLimitError` 
   - Test error message formatting with reset_time
   - Test timeout/retry behavior doesn't apply to 429 (it's not retryable)

9. **Update README documentation**
   - Add "SoundCloud Rate Limiting" section to error handling
   - Explain 15,000 plays per 24 hours
   - Show example: "Rate limit nearly exhausted. Pausing until [time]..."
   - Explain automatic throttling prevents manual waiting
   - Note: playlist creation each track counts as ~1 request

10. **Verify all tests pass**
    - Run full test suite: `npm test`
    - Ensure existing 97 tests still pass
    - Verify 6-8 new tests for rate limiting pass
    - No regressions in other functionality

11. **Commit changes**
    - Branch: `feature/soundcloud-rate-limiting`
    - Message: "feat: implement SoundCloud API rate limit handling"
    - Include: service, client updates, tests, README

## Current Session (Session 11) - In Progress: Enhance Stats Command

### Goal
Update stats command to show releases per genre (fixing README/implementation mismatch) and add optional verbose mode for style breakdown.

### Steps to Implement
1. **Update CollectionService.getStats() return type**
   - Change from returning `genres: string[]` to `genreStats: Map<string, number>` (genre name → release count)
   - Add `styleStats?: Map<string, number>` for verbose mode
   - Current: returns only unique genre names (array)
   - Target: returns genre names with count of releases containing that genre

2. **Implement getGenreStats() method in CollectionService**
   - Iterate through all releases and count occurrences of each genre
   - Handle comma-separated genres in each release (split and count each)
   - Return sorted map by count descending
   - Reuse for both stats and optional verbose stats

3. **Implement getStyleStats() method in CollectionService** (for verbose mode)
   - Similar to getGenreStats but for styles field
   - Only called when verbose flag is set
   - Return sorted map by count descending

4. **Update stats command to accept --verbose flag**
   - Add `.option('-v, --verbose', 'Show detailed stats including style breakdown')`
   - Pass verbose flag to collectionService.getStats(verbose)

5. **Update CollectionService.getStats(verbose?) signature**
   - Accept optional verbose boolean parameter
   - Call getStyleStats() only when verbose is true
   - More efficient than always calculating styles

6. **Update stats command output formatting**
   - Show "Top Genres:" with counts (e.g., "Rock: 15 releases")
   - Display top 10 genres sorted by release count (descending)
   - When verbose: add "Top Styles:" section below genres with same format
   - Format: `  • Genre Name: N releases`

7. **Update README stats section**
   - Fix example output to match new format with release counts
   - Add verbose example: `npm run dev -- stats yosemsweet --verbose`
   - Update output section to show genre counts

8. **Add tests for new stats functionality**
   - Test getGenreStats() returns correct genre counts
   - Test getStyleStats() returns correct style counts
   - Test stats command output includes genre counts
   - Test verbose flag triggers style stats calculation
   - Test sorting by count (descending)
   - Update existing stats tests (currently 3 tests checking old behavior)

9. **Verify all tests pass**
   - Run full test suite: `npm test`
   - Ensure 93+ tests passing (adding ~5-6 new tests)
   - Check no regressions in existing functionality

10. **Commit changes**
    - Branch: `feature/stats-command-enhancement`
    - Message: "feat: enhance stats command with genre/style breakdown by count"
    - Include: CollectionService, stats command, tests, README

## Completed Features Summary