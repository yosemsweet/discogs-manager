# Discogs Manager CLI - Development Plan

## Project Overview
Command-line tool for managing Discogs collections and creating SoundCloud playlists. Full TypeScript/Node.js implementation with 6 commands (sync, list, stats, playlist, auth, retry), 450/451 tests passing (99.8%), production-ready with advanced error recovery.

**Build Status:** ‚úÖ Clean | **Tests:** 450/451 (99.8% passing, 1 skipped) | **Current Branch:** feature/graceful-error-recovery

---

## Completed Work

### Prior Sessions (1-15)
Core CLI, Discogs API integration, SoundCloud OAuth 2.1, rate limiting, database, 5 commands (sync, list, stats, playlist, auth, retry), advanced filtering, retry/DLQ queues, progress feedback.

### Phase 1: Stability & Quality ‚úÖ COMPLETE
**Effort:** ~7-8 hours total
- **Task 1:** Fixed 4 integration tests (91/95 ‚Üí 125/125)
- **Task 2:** Refactored 6 commands with CommandBuilder utility (-180 boilerplate lines)
- **Task 3:** Created ErrorHandler with centralized error classification (13 error types)

### Phase 2: Services & Validation ‚úÖ COMPLETE

**Priority 1: Enable TypeScript Strict Mode** ‚úÖ COMPLETE
- Effort: 4-6h | Impact: HIGH
- Enabled `strict: true` in tsconfig.json
- All code refactored to comply with strict type checking
- 28 files updated with proper type annotations
- ESLint and Prettier configurations applied
- All 323 tests passing with strict mode enforced

**Priority 2: Refactor PlaylistService** ‚úÖ COMPLETE
- Created TrackSearchService (89 lines) - track searching with rate limiting
- Created PlaylistBatchManager (86 lines) - batch API operations with smart chunking
- Refactored PlaylistService (305 ‚Üí 175 lines, -43% reduction)
- All tests passing, no behavioral changes

**Priority 3: Add Input Validation Layer** ‚úÖ COMPLETE
- Created Validator utility with schema validation
- Validates commands, API responses, user inputs
- 28 validation test cases covering all command types

### Phase 3: Performance ‚úÖ COMPLETE

**Priority 1: Implement Caching Layer** ‚úÖ COMPLETE
- CacheService with 24-hour TTL and auto-cleanup
- Hit/miss statistics and memory efficiency tracking
- 39 comprehensive tests
- Production-ready

**Priority 2: Database Access Refactoring** ‚úÖ COMPLETE
- QueryBuilder with fluent SQL API and prepared statements
- TransactionManager for atomic operations
- CommonQueries helper for pagination, search, count
- 35 comprehensive tests
- Production-ready

**Priority 3: Improve Concurrency** ‚úÖ COMPLETE
- ConcurrencyManager for parallel task execution with limits and retries
- RateLimiter with token bucket algorithm
- BatchProcessor for sequential and parallel batch processing
- 30 comprehensive tests
- Production-ready

### Phase 4: Robustness - 75% COMPLETE

**Priority 1: OAuth Refresh Token Implementation** ‚úÖ COMPLETE
- OAuth 2.1 with PKCE flow for CLI applications
- Encrypted token storage (AES-256-GCM) in database
- Auto-refresh 5 minutes before expiry
- Comprehensive error handling and token validation
- 24 integration tests
- Production-ready with live testing verified

**Priority 2: Enhanced Logging** ‚úÖ COMPLETE
- Structured JSON logging with context data
- Multiple log levels (DEBUG, INFO, WARN, ERROR)
- Operation tracing with automatic timing and trace IDs
- Daily log rotation with JSON format
- Configurable via LOG_LEVEL and LOG_DIR environment variables
- Backwards compatible with existing code
- 31 comprehensive test cases
- Complete documentation: ENHANCED_LOGGING.md

**Priority 3: Graceful Error Recovery** üü¢ IN PROGRESS (75% COMPLETE)
- **Sync Checkpoints Service** ‚úÖ COMPLETE (36 tests)
  - Resume capability for interrupted syncs
  - Track processed/failed items with full recovery info
  - Database schema: sync_checkpoints, processed_items tables
  - Statistics and progress tracking
  - Checkpoint cleanup for maintenance

- **Circuit Breaker Pattern** ‚úÖ COMPLETE (34 tests)
  - CLOSED, OPEN, HALF_OPEN states
  - Configurable failure/success thresholds
  - Automatic recovery attempts
  - Both async and sync execution
  - Metrics: state, failure/success counts, success rate
  - Global CircuitBreakerManager for managing multiple breakers

- **Timeout Handler** ‚úÖ COMPLETE (34 tests)
  - Async execution with configurable timeout
  - Retry logic with backoff strategy
  - Operation cancellation (individual and batch)
  - Timeout callbacks for cleanup
  - Metrics: remaining time, elapsed, timeout count
  - withTimeout helper and singleton instance

**Priority 4: Data Sanitization & Security** ‚è≥ NOT STARTED

Total Phase 4 tests added this session: 104 tests (36 + 34 + 34)
Total project tests: 450/451 (99.8% passing)

---

## Implementation Details (OAuth Refresh Tokens)
- Encryption happens transparently - only encrypted blobs stored in DB

**2. Database Schema Changes**
- New table: `soundcloud_tokens`
  ```sql
  CREATE TABLE soundcloud_tokens (
    id INTEGER PRIMARY KEY,
    access_token_encrypted TEXT NOT NULL,
    access_token_iv TEXT NOT NULL,
    access_token_auth_tag TEXT NOT NULL,
    refresh_token_encrypted TEXT NOT NULL,
    refresh_token_iv TEXT NOT NULL,
    refresh_token_auth_tag TEXT NOT NULL,
    expires_at INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    updated_at INTEGER NOT NULL,
    UNIQUE(id)
  )
  ```
- Migration: Create table if not exists (handle both old and new installations)
- Store token expiration time for proactive refresh (refresh when expires_at - 5min < now)

**3. OAuth Flow Changes**
- Command: `auth` - generates both access_token AND refresh_token on first auth
- Store both tokens encrypted in database (no longer in `.env`)
- Remove SOUNDCLOUD_USER_TOKEN from `.env` (token now lives in DB)
- Keep SOUNDCLOUD_CLIENT_ID and ENCRYPTION_KEY in `.env`

**4. Token Refresh Service**
- Create `SoundCloudOAuthService` with:
  ```typescript
  getValidAccessToken(): Promise<string>
    - Check if token expired (expires_at - 5min < now)
    - If expired: call refreshAccessToken()
    - Return valid access token (decrypt from DB)
  
  refreshAccessToken(): Promise<void>
    - Decrypt refresh_token from DB
    - POST to SoundCloud OAuth endpoint with refresh_token
    - Get new access_token and refresh_token
    - Encrypt and update both tokens in DB
    - Update expires_at timestamp
  ```
- Auto-refresh transparent to consumers - they just call getValidAccessToken()

**5. Error Handling**
- If refresh fails: raise AuthenticationError with message "Please re-authenticate with 'npm run dev -- auth'"
- 401 from SoundCloud API triggers token refresh attempt
- If refresh still fails: token is invalid/revoked, require re-auth

**6. Command Updates**
- `auth` command: 
  - Clears old encrypted tokens from DB
  - Gets new tokens
  - Stores both encrypted in DB
  - Shows success message: "‚úì Authenticated! Tokens stored securely in database"
- All other commands: Use `getValidAccessToken()` for API calls

**7. Migration Path (backwards compatibility)**
- Check if `.env` has SOUNDCLOUD_USER_TOKEN
- If found: migrate to database encryption (one-time)
- Remove SOUNDCLOUD_USER_TOKEN from `.env` with warning
- Log: "Migrated legacy token to encrypted storage"

**8. Security Considerations**
- ENCRYPTION_KEY env var is critical - warn users: "Never commit encryption key changes"
- If key changes, existing tokens become unrecoverable
- Tokens encrypted at rest, only decrypted when needed
- Consider: Add optional database encryption (SQLCipher) for defense-in-depth
- Token lifetime: SoundCloud tokens (expire in ~12 hours typically)
- Refresh token lifetime: longer (months) - rotate on each refresh

**9. Testing**
- Test encryption/decryption roundtrip
- Test token expiration detection
- Test refresh token flow (mock SoundCloud response)
- Test error handling (invalid refresh token)
- Test migration from .env to DB
- Test auto-refresh on 401 response from API

**10. Documentation Updates**
- Update README: Remove SOUNDCLOUD_USER_TOKEN from .env template
- Add ENCRYPTION_KEY to .env.example with security warning
- Document refresh flow and token lifetime
- Add troubleshooting: "How to re-authenticate"

**Priority 2: Enhanced Logging** ‚≠ê NEXT
- Effort: 2-3h | Impact: MEDIUM
- Structured logging (JSON), log levels, rotation, operation tracing

**Priority 3: Graceful Error Recovery** ‚≠ê NEXT
- Effort: 3-4h | Impact: MEDIUM
- Retry with backoff, partial sync recovery, circuit breaker, timeout handling

**Priority 4: Data Sanitization & Security** ‚≠ê NEXT
- Effort: 2-3h | Impact: LOW
- Input sanitization, rate limiting, OAuth security, secrets management

### Phase 5: Documentation (WEEKS 9-10)

**Priority 1: Comprehensive Documentation**
- Effort: 3-4h | Impact: MEDIUM
- ARCHITECTURE.md, API reference, troubleshooting, config documentation

**Priority 2: Improve Test Coverage**
- Effort: 4-5h | Impact: HIGH
- Edge case tests, performance benchmarks, integration tests, coverage reporting

**Priority 3: Setup CI/CD**
- Effort: 2-3h | Impact: MEDIUM
- GitHub Actions, pre-commit hooks, automated deployment, versioning

---

## Known Issues
- Playlist creation occasionally fails with 422 on certain genres
- Rate limit reset time may be off by seconds in edge cases

---

## Quick Reference

**Build/Test:**
```bash
npm run build   # TypeScript compilation (strict mode)
npm test        # All 346 tests (1 skipped)
npm run dev -- sync    # Test command
npm run dev -- playlist -t "World Music" -g "World"  # Test playlist
npm run dev -- auth    # Test OAuth
./test-workflow.sh     # Complete workflow test

# Set log level (default: info)
LOG_LEVEL=debug npm run dev -- sync

# Set custom log directory
LOG_DIR=/var/log/discogs-manager npm run dev
```

**Docs:**
- `CODEBASE_REVIEW.md` - Detailed analysis
- `README.md` - User guide
- `API_REFERENCE.md` - API details
- `PERFORMANCE_OPTIMIZATION.md` - Performance features
- `OAUTH_REFRESH_IMPLEMENTATION.md` - OAuth implementation details
- `ENHANCED_LOGGING.md` - Logging configuration & usage

**Architecture:**
- `src/api/` - API clients (Discogs, SoundCloud)
- `src/services/` - Business logic (collection, playlist, database, OAuth)
- `src/commands/` - CLI commands (sync, list, stats, playlist, auth, retry)
- `src/utils/` - Utilities (cache, query-builder, concurrency, encryption, logger)
- `tests/` - Test suite (346 tests, 100% pass rate)